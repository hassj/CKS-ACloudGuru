# Chapter 6: Supply Chain Security

![Supply chain security cover](https://github.com/hassj/CKA-acloudguru/blob/main/CKA-md/Image/55-Supply-chain-security-cover.JPG "supply chain security cover")

## Chapter 6.2: Minimizing Base Image Attack Surface
[Images](https://kubernetes.io/docs/concepts/containers/images/)

[Security](https://kubernetes.io/docs/concepts/security/)

### we're under Attack

suppose that base image consist of multi software may be contain vulnerabilities. it allows an attacker used to exploit.

### Software vulnerabilities

it is a flaw or weakness of software that can be used by an attacker.
> you need use latest software or patches version of software that contain fixes for software vulnerabilities.

### Minimizing unneccessary Software
more unneccessary software more risk of base image addittion to image. so if not needed any more, need to Minimizing the amount of software

### Compromise Images

an attacker may be create an Compromise image, so that if you used will be open an risk on your application.

## Chapter 6.3: Whitelisting Allowed Image Registries

[OPA gatekeeper blog ](https://kubernetes.io/blog/2019/08/06/opa-gatekeeper-policy-and-governance-for-kubernetes/)

[OPA gatekeeper repo](https://github.com/open-policy-agent/gatekeeper)

### we're under Attack
![compromise image registry](https://github.com/hassj/CKA-acloudguru/blob/main/CKA-md/Image/56-compromise-image.JPG "Compromise image registry")

### Image Registries
it is simply a service that contain the container image provide for download.

### Restricting image Registries

you can restrict untrusted registry from download image by one way that is OPA gatekeeper.

### Hands-on lab
- Creating Constraint template that allows you to whitelist which registry you want.

```
vi k8sallowedrepos.yml

apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
name: k8sallowedrepos
spec:
crd:
spec:
names:
kind: K8sAllowedRepos
validation:
# Schema for the `parameters` field
openAPIV3Schema:
properties:
repos:
type: array
items:
type: string
targets:
- target: admission.k8s.gatekeeper.sh
rego: |
package k8sallowedrepos
violation[{"msg": msg}] {
container := input.review.object.spec.containers[_]
satisfied := [good | repo = input.parameters.repos[_] ; good = startswith(container.image,
repo)]
not any(satisfied)
msg := sprintf("container <%v> has an invalid image repo <%v>, allowed repos are %v",
[container.name, container.image, input.parameters.repos])
}
violation[{"msg": msg}] {
container := input.review.object.spec.initContainers[_]
satisfied := [good | repo = input.parameters.repos[_] ; good = startswith(container.image,
repo)]
not any(satisfied)
msg := sprintf("container <%v> has an invalid image repo <%v>, allowed repos are %v",
[container.name, container.image, input.parameters.repos])
}

kubectl create -f k8sallowedrepos.yml

```
- Create a constraint that only allows images from Docker Hub:

```
vi whitelist-dockerhub.yml

apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sAllowedRepos
metadata:
name: whitelist-dockerhub
spec:
match:
kinds:
- apiGroups: [""]
kinds: ["Pod"]
parameters:
repos:
- "docker.io"
```

## Chapter 6.4: Validating Signed Images

[busybox docker hub](https://hub.docker.com/layers/library/busybox/1.33.1-glibc/images/sha256-9687821b96b24fa15fac11d936c3a633ce1506d5471ebef02c349d85bebb11b5)

### Image signature

- It used to verify the content of image that allows you to sure an attacker hadn't added malisious code to the image.

- Container image can be sign using hash generated by unique content of image.

### Validating images

- you can use SHA256 hash to validate an Image

![validating image](https://github.com/hassj/CKA-acloudguru/blob/main/CKA-md/Image/57-validating-image.JPG "validating image")

### Hands-on lab

- Creating a simple pod with signed image

![pod with signed image](https://github.com/hassj/CKA-acloudguru/blob/main/CKA-md/Image58-validating-image-lab.JPG "pod with signed image")

> take a notice that after name of image is @sha256:$hash , the hash number given on docker hub repo.

![pod with signed image which wrong hash](https://github.com/hassj/CKA-acloudguru/blob/main/CKA-md/Image58-validating-image-lab-2.JPG)

## Chapter 6.5: Analyzing a Dockerfile

[Docker file refference](https://docs.docker.com/reference/dockerfile/)

### Static analysis dockerfile 
- It is a process looking for a source code or configuration to identify potential security issues.

- One way to harden the docker image is to analysis the Dockerfile used to create them.

- There are many auto tool to scan risk issue in docker file, but this course we will analysis issue manually.

### Look at something a Dockerfile
- User root or 0 ( root user id) : the final USER Directive in dockerfile is set to root, the container process will run as user root. It's usually a good idea to avoid this.

- latest:tag  in FROM directive : in case an hacker create compromise image and tag with the latest, it will cause you do not identify what is the real image. so you will run Compromise code for your app.

- unneccessary software: the more software installed the more potential risk on your app.

- Sensitive data: you should use somethings like k8s secret to pass sensitive data to the container runtime rather than store it in image.

### Hands-on lab
- A simple Dockerfile

```
FROM nginx:1.19.10

USER root

RUN apt-get update && apt-get install -y wget
RUN useradd -ms /bin/bash nginxuser
ENV db_password=Mellon

USER root

ENTRYPOINT ["/docker-entrypoint.sh"]
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

> im going to corret some of security issue on simple Dockerfile.
> - the first USER directive which you dont need to worried about it, because that's not actually determing the default user which used to run in container process.
> - second that is the unneccessary software `apt-get update....`
> - third that is sensitive data 
> - finally we checkout the image version, and make sure to use the base image instead of latest image

- The correct Dockerfile

```
FROM nginx:1.19.10

USER root

RUN apt-get update && apt-get install -y wget	//delete this line, this is unneccessary software.
RUN useradd -ms /bin/bash nginxuser
ENV db_password=Mellon		// delete this line, use Sensitive data with k8s secret object

USER nginxuser 	//avoid using ROOT USER

ENTRYPOINT ["/docker-entrypoint.sh"]
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

### Tips

## CHAPTER 6.7: Analyzing Resource YAML Files

[Cloud native Security](https://kubernetes.io/docs/concepts/security/)

- sameple yaml file
```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: static-analysis-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: static-analysis-deployment
  template:
    metadata:
      labels:
        app: static-analysis-deployment
    spec:
      hostIPC: true
      hostNetwork: true
      hostPID: true
      containers:
      - name: nginx
        image: nginx:latest
        ports:
        - containerPort: 80
        securityContext:
          privileged: true
```

### Static analysis yaml file
Manually checkout the security of yaml file

### Some things to look for
- host namespace: dont let containers use the host namespace if possible

- privilege mode: dont let containers use privilege mode unless absolutely necessary

- User root directive: in Dockerfile, if will be run as user Root for Container

- :latest tag: use specific tag, instead of latest tag 

### Hands-on lab

### Tips

## Chapter 6.9: Scanning Images for Known Vulnerabilities

[Cloud native security container](https://kubernetes.io/docs/concepts/security/#container)

[trivy documentation](https://github.com/aquasecurity/trivy)

### We're under Attack

### What is vulnerability

### What is the vulnerabilities Scanning

means using tools to scanning or detect known vulnerabilities in your software.

### Tivy tools
That is a command-line tools allows you to scan container images for vulnerabilities.
`trivy image nginx:1.1.10` or sometimes `trivy nginx.1.1.10` 

![Trivy reported](https://github.com/hassj/CKA-acloudguru/blob/main/CKA-md/Image/59-trivy-report.JPG "Trivy reported")

### Hands-on lab
- Installing trivy

```
wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a
/etc/apt/sources.list.d/trivy.list
sudo apt-get update && sudo apt-get install -y trivy

```

### Exam Tips

## Chapter 6.11: Scanning Images with an Admission Controller

[cloud native security](https://kubernetes.io/docs/concepts/security/#container)

[Image Policy webhook admission controller](https://kubernetes.io/docs/concepts/security/#container)

### Admission controller

- It intercept request to k8s api 

- It can be allow or deny or modify request before changes are actually made.

### ImagePolicy webhook admission controller

- the ImagePolicyWebhook controller sends a request to an external webhook containing information about the image being used.

- The webhook can approve or deny the creation of the workload based on the image.

- This functionality can be used to automatically scan images and deny workloads if there are severe vulnerabilities.

![ImagePolicyWEbhook](https://github.com/hassj/CKA-acloudguru/blob/main/CKA-md/Image/60-imagePolicy-webhook.JPG "image policy webhook")

### Tips

## Chapter 6.12: Setting up an Image Scanner

[Image Policy webhook](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#imagepolicywebhook)

[sample webhook app source code](https://github.com/linuxacademy/content-cks-trivy-k8s-webhook)

### Our goal
- In order to scan incomming images using imagepolicywebhook, we need an application that can receive the webhook requests and perform the image scanning.
We need to create external webhook 

### Hands-on lab

- Installing application play as imagePolicywebhook server on control plane node 

![Image scanner lab 1](https://github.com/hassj/CKA-acloudguru/blob/main/CKA-md/Image/61-image-scanner-lab-1.JPG)

![Image scanner lab 1](https://github.com/hassj/CKA-acloudguru/blob/main/CKA-md/Image/61-image-scanner-lab-2.JPG)


### Tips

## Chapter 6.13: Configuring the ImagePolicyWebhook Admission Controller

[Image Policy webhook](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#imagepolicywebhook)

- download ca.crt
- download client cert and key, used to communicate with external service 
- Creating admmision control configuration
> ``defaultAllow: true`` directive allows incomming image when external webhook service goes down or not. 

![configuring admmision controller](https://github.com/hassj/CKA-acloudguru/blob/main/CKA-md/Image/62-image-scanner-lab-1.JPG)

- Creating kubeconfig that talked about above step

![configuring admmision controller](https://github.com/hassj/CKA-acloudguru/blob/main/CKA-md/Image/62-image-scanner-lab-2.JPG)

> .cluster.server directive specify the external webhook server.

- then enable admmision controller on kube-api-server, and specify the path of admmission controller configuration file. but kube-api-server is running on static pod, it won't actually see the admmission controller path,
we need to mount that file to volume (see lab image 4 and 5 ) 

![configuring admmision controller](https://github.com/hassj/CKA-acloudguru/blob/main/CKA-md/Image/62-image-scanner-lab-3.JPG)

![configuring admmision controller](https://github.com/hassj/CKA-acloudguru/blob/main/CKA-md/Image/62-image-scanner-lab-4.JPG)

![configuring admmision controller](https://github.com/hassj/CKA-acloudguru/blob/main/CKA-md/Image/62-image-scanner-lab-5.JPG)

> whenever you made changes on kubeapi-server it will short outage for the while to recreate new pod.

![configuring admmision controller](https://github.com/hassj/CKA-acloudguru/blob/main/CKA-md/Image/62-image-scanner-lab-6.JPG)

- You can disable this functionality just remove imagepolicy on admmission controller plugin.

`sudo vi /etc/kubernetes/manifest/kube-apiserver.yaml`

![configuring admmision controller](https://github.com/hassj/CKA-acloudguru/blob/main/CKA-md/Image/62-image-scanner-lab-7.JPG)

### Examp Tips

![Exam Tips](https://github.com/hassj/CKA-acloudguru/blob/main/CKA-md/Image/63-imagePolicy-controller-1.JPG)

![Exam Tips](https://github.com/hassj/CKA-acloudguru/blob/main/CKA-md/Image/63-imagePolicy-controller-2.JPG)

## Chapter 6.15 Supply Chain security review

### Images

- Try to use images that run up to date software to minimize software vulnerabilities

- Minimize the amount of unneccessary software that will could increase security risks.

- Beaware of the possibility of images that have been compromised by attacker.

### Whitelist images registry

- limit users to only trusted image registries to prevent them from running images from untrusted sources in the cluster.

- You can use tool like OPA gatekeeper to whitelist image registry

### Image validation

- Container images can be signed with a hash generated by the content of image 

- you can append the hash to container image: imageName:tag@sha256:hash

### Static analysis: Dockerfile

- to avoid running container as ROOT user. or user ID of 0.

- Avoid use latest to tag the image version

- Try to avoid including unnecessary software in the final Image

- Avoid storing sensitive data like password in the Dockerfile. Use secret instead.

### Static analysis YAML

- when possible, avoid the use of host namespace such as (hostNetwork, hostPID, hostIPC)

- when possible, avoid using privileged containers with privileged: true

- Avoid running as user ROOT or user ID 0 in securityContext. runAsUser

- Don't use the latest:tag, but instead of use specific tag, or fixed tag to avoid downloadind new image and potentially unvetted image

### Vulnerable Scanning

64-vulnerable-scan.JPG

65-vulnerable-scaning-admission-controller.JPG

65-vulnerable-scaning-admission-controller-2.JPG

65-vulnerable-scaning-admission-controller-3.JPG

65-vulnerable-scaning-admission-controller-4.JPG
