# Chapter 6: Supply Chain Security

![Supply chain security cover](https://github.com/hassj/CKA-acloudguru/blob/main/CKA-md/Image/55-Supply-chain-security-cover.JPG "supply chain security cover")

## Chapter 6.2: Minimizing Base Image Attack Surface
[Images](https://kubernetes.io/docs/concepts/containers/images/)

[Security](https://kubernetes.io/docs/concepts/security/)

### we're under Attack

suppose that base image consist of multi software may be contain vulnerabilities. it allows an attacker used to exploit.

### Software vulnerabilities

it is a flaw or weakness of software that can be used by an attacker.
> you need use latest software or patches version of software that contain fixes for software vulnerabilities.

### Minimizing unneccessary Software
more unneccessary software more risk of base image addittion to image. so if not needed any more, need to Minimizing the amount of software

### Compromise Images

an attacker may be create an Compromise image, so that if you used will be open an risk on your application.

## Chapter 6.3: Whitelisting Allowed Image Registries

[OPA gatekeeper blog ](https://kubernetes.io/blog/2019/08/06/opa-gatekeeper-policy-and-governance-for-kubernetes/)

[OPA gatekeeper repo](https://github.com/open-policy-agent/gatekeeper)

### we're under Attack
![compromise image registry](https://github.com/hassj/CKA-acloudguru/blob/main/CKA-md/Image/56-compromise-image.JPG "Compromise image registry")

### Image Registries
it is simply a service that contain the container image provide for download.

### Restricting image Registries

you can restrict untrusted registry from download image by one way that is OPA gatekeeper.

### Hands-on lab
- Creating Constraint template that allows you to whitelist which registry you want.

```
vi k8sallowedrepos.yml

apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
name: k8sallowedrepos
spec:
crd:
spec:
names:
kind: K8sAllowedRepos
validation:
# Schema for the `parameters` field
openAPIV3Schema:
properties:
repos:
type: array
items:
type: string
targets:
- target: admission.k8s.gatekeeper.sh
rego: |
package k8sallowedrepos
violation[{"msg": msg}] {
container := input.review.object.spec.containers[_]
satisfied := [good | repo = input.parameters.repos[_] ; good = startswith(container.image,
repo)]
not any(satisfied)
msg := sprintf("container <%v> has an invalid image repo <%v>, allowed repos are %v",
[container.name, container.image, input.parameters.repos])
}
violation[{"msg": msg}] {
container := input.review.object.spec.initContainers[_]
satisfied := [good | repo = input.parameters.repos[_] ; good = startswith(container.image,
repo)]
not any(satisfied)
msg := sprintf("container <%v> has an invalid image repo <%v>, allowed repos are %v",
[container.name, container.image, input.parameters.repos])
}

kubectl create -f k8sallowedrepos.yml

```
- Create a constraint that only allows images from Docker Hub:

```
vi whitelist-dockerhub.yml

apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sAllowedRepos
metadata:
name: whitelist-dockerhub
spec:
match:
kinds:
- apiGroups: [""]
kinds: ["Pod"]
parameters:
repos:
- "docker.io"
```

## Chapter 6.4: Validating Signed Images

[busybox docker hub](https://hub.docker.com/layers/library/busybox/1.33.1-glibc/images/sha256-9687821b96b24fa15fac11d936c3a633ce1506d5471ebef02c349d85bebb11b5)

### Image signature

- It used to verify the content of image that allows you to sure an attacker hadn't added malisious code to the image.

- Container image can be sign using hash generated by unique content of image.

### Validating images

- you can use SHA256 hash to validate an Image

![validating image](https://github.com/hassj/CKA-acloudguru/blob/main/CKA-md/Image/57-validating-image.JPG "validating image")

### Hands-on lab

- Creating a simple pod with signed image

![pod with signed image](https://github.com/hassj/CKA-acloudguru/blob/main/CKA-md/Image58-validating-image-lab.JPG "pod with signed image")

> take a notice that after name of image is @sha256:$hash , the hash number given on docker hub repo.

![pod with signed image which wrong hash](https://github.com/hassj/CKA-acloudguru/blob/main/CKA-md/Image58-validating-image-lab-2.JPG)

## Chapter 6.5: Analyzing a Dockerfile

[Docker file refference](https://docs.docker.com/reference/dockerfile/)

### Static analysis dockerfile 
- It is a process looking for a source code or configuration to identify potential security issues.

- One way to harden the docker image is to analysis the Dockerfile used to create them.

- There are many auto tool to scan risk issue in docker file, but this course we will analysis issue manually.

### Look at something a Dockerfile
- User root: the final USER Directive in dockerfile is set to root, the container process will run as user root. It's usually a good idea to avoid this.

- latest:tag - in case an hacker create compromise image and tag with the latest, it will cause you do not identify what is the real image. so you will run Compromise code for your app.

- unneccessary software: the more software installed the more potential risk on your app.

- Sensitive data: you should use somethings like k8s secret to pass sensitive data to the container runtime rather than store it in image.

### Hands-on lab
- A simple Dockerfile

```
FROM nginx:1.19.10

USER root

RUN apt-get update && apt-get install -y wget
RUN useradd -ms /bin/bash nginxuser
ENV db_password=Mellon

USER root

ENTRYPOINT ["/docker-entrypoint.sh"]
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

> im going to corret some of security issue on simple Dockerfile.
> - the first USER directive which you dont need to worried about it, because that's not actually determing the default user which used to run in container process.
> - second that is the unneccessary software `apt-get update....`
> - third that is sensitive data 
> - finally we checkout the image version, and make sure to use the base image instead of latest image

- The correct Dockerfile

```
FROM nginx:1.19.10

USER root

~~ RUN apt-get update && apt-get install -y wget ~~	//delete this line, this is unneccessary software.
RUN useradd -ms /bin/bash nginxuser
~~ ENV db_password=Mellon  ~~		// delete this line, use Sensitive data with k8s secret object

USER nginxuser 	//avoid using ROOT USER

ENTRYPOINT ["/docker-entrypoint.sh"]
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

### Tips


